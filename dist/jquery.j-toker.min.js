/*! j-toker - v0.0.10-beta3 - 2016-08-19
* Copyright (c) 2016 Lynn Dylan Hurley; Licensed WTFPL */
!function(a){"function"==typeof define&&define.amd?define(["jquery","jquery-deparam","pubsub-js","js-cookie"],a):"object"==typeof exports?module.exports=a(require("jquery"),require("jquery-deparam"),require("pubsub-js"),require("js-cookie")):a(window.jQuery,window.deparam,window.PubSub,window.Cookies)}(function(a,b,c,d){var e=Function("return this")();if(e.auth)return e.auth;var f=e.navigator,g="default",h="currentConfigName",i="authHeaders",j="firstTimeLogin",k="mustResetPassword",l="auth.validation.success",m="auth.validation.error",n="auth.emailRegistration.success",o="auth.emailRegistration.error",p="auth.passwordResetRequest.success",q="auth.passwordResetRequest.error",r="auth.emailConfirmation.success",s="auth.emailConfirmation.error",t="auth.passwordResetConfirm.success",u="auth.passwordResetConfirm.error",v="auth.emailSignIn.success",w="auth.emailSignIn.error",x="auth.oAuthSignIn.success",y="auth.oAuthSignIn.error",z="auth.signIn.success",A="auth.signIn.error",B="auth.signOut.success",C="auth.signOut.error",D="auth.accountUpdate.success",E="auth.accountUpdate.error",F="auth.destroyAccount.success",G="auth.destroyAccount.error",H="auth.passwordUpdate.success",I="auth.passwordUpdate.error",J=function(){this.configured=!1,this.configDfd=null,this.configs={},this.defaultConfigKey=null,this.firstTimeLogin=!1,this.mustResetPassword=!1,this.user={},this.oAuthDfd=null,this.oAuthTimer=null,this.configBase={apiUrl:"/api",signOutPath:"/auth/sign_out",emailSignInPath:"/auth/sign_in",emailRegistrationPath:"/auth",accountUpdatePath:"/auth",accountDeletePath:"/auth",passwordResetPath:"/auth/password",passwordUpdatePath:"/auth/password",tokenValidationPath:"/auth/validate_token",proxyIf:function(){return!1},proxyUrl:"/proxy",forceHardRedirect:!1,storage:"cookies",cookieExpiry:14,cookiePath:"/",initialCredentials:null,passwordResetSuccessUrl:function(){return e.location.href},confirmationSuccessUrl:function(){return e.location.href},tokenFormat:{"access-token":"{{ access-token }}","token-type":"Bearer",client:"{{ client }}",expiry:"{{ expiry }}",uid:"{{ uid }}"},parseExpiry:function(a){return 1e3*parseInt(a.expiry,10)||null},handleLoginResponse:function(a){return a.data},handleAccountUpdateResponse:function(a){return a.data},handleTokenValidationResponse:function(a){return a.data},authProviderPaths:{github:"/auth/github",facebook:"/auth/facebook",google:"/auth/google_oauth2"}}};J.prototype.reset=function(){this.destroySession(),this.configs={},this.defaultConfigKey=null,this.configured=!1,this.configDfd=null,this.mustResetPassword=!1,this.firstTimeLogin=!1,this.oAuthDfd=null,this.willRedirect=!1,this.oAuthTimer&&(clearTimeout(this.oAuthTimer),this.oAuthTimer=null);for(var b in this.user)delete this.user[b];a(document).unbind("ajaxComplete",this.updateAuthCredentials),e.removeEventListener&&e.removeEventListener("message",this.handlePostMessage),a.ajaxSetup({beforeSend:void 0})},J.prototype.invalidateTokens=function(){for(var a in this.user)delete this.user[a];this.deleteData(h),this.deleteData(i)},J.prototype.checkDependencies=function(){var f=[],g=[];if(!a)throw"jToker: jQuery not found. This module depends on jQuery.";if(e.localStorage||d||f.push("This browser does not support localStorage. You must install js-cookie to use jToker with this browser."),b||f.push("Dependency not met: jquery-deparam."),c||g.push("jquery.ba-tinypubsub.js not found. No auth events will be broadcast."),f.length){var h=f.join(" ");throw"jToker: Please resolve the following errors: "+h}if(g.length&&console&&console.warn){var i=g.join(" ");console.warn("jToker: Warning: "+i)}},J.prototype.destroySession=function(){var a=[i,h];for(var b in a)if(b=a[b],e.localStorage&&e.localStorage.removeItem(b),d){for(var c in this.configs){var f=this.configs[c].cookiePath;d.remove(b,{path:f})}d.remove(b,{path:"/"})}},J.prototype.configure=function(b,c){if(c&&this.reset(),this.configured)return this.configDfd;if(this.configured=!0,b||(b={}),b.constructor!==Array){this.defaultConfigKey=g;var d={};d[this.defaultConfigKey]=b,b=[d]}for(var f=0;f<b.length;f++){var h=K(b[f]);this.defaultConfigKey||(this.defaultConfigKey=h),this.configs[h]=a.extend({},this.configBase,b[f][h])}if(this.checkDependencies(),a(document).ajaxComplete(e.auth.updateAuthCredentials),a.ajaxSetup({beforeSend:e.auth.appendAuthHeaders}),e.addEventListener&&e.addEventListener("message",this.handlePostMessage,!1),this.processSearchParams(),this.willRedirect)return!1;if(this.getConfig().initialCredentials){var l=this.getConfig();return this.persistData(i,l.initialCredentials.headers),this.persistData(k,l.initialCredentials.mustResetPassword),this.persistData(j,l.initialCredentials.firstTimeLogin),this.setCurrentUser(l.initialCredentials.user),(new a.Deferred).resolve(l.initialCredentials.user)}return this.configDfd=this.validateToken({config:this.getCurrentConfigName()}),this.configDfd},J.prototype.getApiUrl=function(){var a=this.getConfig();return a.proxyIf()?a.proxyUrl:a.apiUrl},J.prototype.buildAuthHeaders=function(a){var b={},c=this.getConfig().tokenFormat;for(var d in c)b[d]=N(c[d],a);return b},J.prototype.setCurrentUser=function(b){for(var c in this.user)delete this.user[c];return a.extend(this.user,b),this.user.signedIn=!0,this.user.configName=this.getCurrentConfigName(),this.user},J.prototype.handlePostMessage=function(a){var b=!1;if("deliverCredentials"===a.data.message){delete a.data.message;var c=e.auth.normalizeTokenKeys(a.data),d=e.auth.buildAuthHeaders(c),f=e.auth.setCurrentUser(a.data);e.auth.persistData(i,d),e.auth.resolvePromise(x,e.auth.oAuthDfd,f),e.auth.broadcastEvent(z,f),e.auth.broadcastEvent(l,f),b=!0}"authFailure"===a.data.message&&(e.auth.rejectPromise(y,e.auth.oAuthDfd,a.data,"OAuth authentication failed."),e.auth.broadcastEvent(A,a.data),b=!0),b&&(clearTimeout(e.auth.oAuthTimer),e.auth.oAuthTimer=null)},J.prototype.normalizeTokenKeys=function(a){return a.token&&(a["access-token"]=a.token,delete a.token),a.auth_token&&(a["access-token"]=a.auth_token,delete a.auth_token),a.client_id&&(a.client=a.client_id,delete a.client_id),a.config&&(this.persistData(h,a.config,a.config),delete a.config),a},J.prototype.processSearchParams=function(){var a=this.getQs(),b=null;if(a=this.normalizeTokenKeys(a),a["access-token"]&&a.uid){b=this.buildAuthHeaders(a),this.persistData(i,b),a.reset_password&&this.persistData(k,!0),a.account_confirmation_success&&this.persistData(j,!0);var c=this.getLocationWithoutParams(["access-token","token","auth_token","config","client","client_id","expiry","uid","reset_password","account_confirmation_success"]);this.willRedirect=!0,this.setLocation(c)}return b},J.prototype.getLocationWithoutParams=function(b){var c=a.param(this.stripKeys(this.getSearchQs(),b)),d=a.param(this.stripKeys(this.getAnchorQs(),b)),f=e.location.hash.split("?")[0];c&&(c="?"+c),d&&(f+="?"+d),f&&!f.match(/^#/)&&(f="#/"+f);var g=e.location.protocol+"//"+e.location.host+e.location.pathname+c+f;return g},J.prototype.stripKeys=function(a,b){for(var c in b)delete a[b[c]];return a},J.prototype.broadcastEvent=function(a,b){c.publish&&c.publish(a,b)},J.prototype.resolvePromise=function(b,c,d){var e=this,f=a.Deferred();return setTimeout(function(){e.broadcastEvent(b,d),c.resolve(d),f.resolve()},0),f.promise()},J.prototype.rejectPromise=function(b,c,d,e){var f=this;return d=a.parseJSON(d&&d.responseText||"{}"),setTimeout(function(){f.broadcastEvent(b,d),c.reject({reason:e,data:d})},0),c},J.prototype.validateToken=function(b){if(b||(b={}),b.config||(b.config=this.getCurrentConfigName()),this.configDfd)return this.configDfd;var c=a.Deferred();if(this.retrieveData(i)){var d=this.getConfig(b.config),e=this.getApiUrl()+d.tokenValidationPath;a.ajax({url:e,context:this,success:function(a){var b=d.handleTokenValidationResponse(a);this.setCurrentUser(b),this.retrieveData(j)&&(this.broadcastEvent(r,a),this.persistData(j,!1),this.firstTimeLogin=!0),this.retrieveData(k)&&(this.broadcastEvent(t,a),this.persistData(k,!1),this.mustResetPassword=!0),this.resolvePromise(l,c,this.user)},error:function(a){this.invalidateTokens(),this.retrieveData(j)&&(this.broadcastEvent(s,a),this.persistData(j,!1)),this.retrieveData(k)&&(this.broadcastEvent(u,a),this.persistData(k,!1)),this.rejectPromise(m,c,a,"Cannot validate token; token rejected by server.")}})}else this.invalidateTokens(),this.rejectPromise(m,c,{},"Cannot validate token; no token found.");return c.promise()},J.prototype.emailSignUp=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.emailRegistrationPath,e=a.Deferred();return b.config_name=b.config,delete b.config,b.confirm_success_url=c.confirmationSuccessUrl(),a.ajax({url:d,context:this,method:"POST",data:b,success:function(a){this.resolvePromise(n,e,a)},error:function(a){this.rejectPromise(o,e,a,"Failed to submit email registration.")}}),e.promise()},J.prototype.emailSignIn=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.emailSignInPath,e=a.Deferred();return delete b.config,a.ajax({url:d,context:this,method:"POST",data:b,success:function(a){var b=c.handleLoginResponse(a);this.setCurrentUser(b),this.resolvePromise(v,e,a),this.broadcastEvent(z,b),this.broadcastEvent(l,this.user)},error:function(a){this.rejectPromise(w,e,a,"Invalid credentials."),this.broadcastEvent(A,a)}}),e.promise()},J.prototype.listenForCredentials=function(a){var b=this;a.closed?b.rejectPromise(y,b.oAuthDfd,null,"OAuth window was closed bofore registration was completed."):(a.postMessage("requestCredentials","*"),b.oAuthTimer=setTimeout(function(){b.listenForCredentials(a)},500))},J.prototype.openAuthWindow=function(a){if(this.getConfig().forceHardRedirect||e.isIE())this.setLocation(a);else{var b=this.createPopup(a);this.listenForCredentials(b)}},J.prototype.buildOAuthUrl=function(a,b,c){var d=this.getConfig().apiUrl+c+"?auth_origin_url="+encodeURIComponent(e.location.href)+"&config_name="+encodeURIComponent(a||this.getCurrentConfigName())+"&omniauth_window_type=newWindow";if(b)for(var f in b)d+="&",d+=encodeURIComponent(f),d+="=",d+=encodeURIComponent(b[f]);return d},J.prototype.oAuthSignIn=function(b){if(b||(b={}),!b.provider)throw"jToker: provider param undefined for `oAuthSignIn` method.";var c=this.getConfig(b.config),d=c.authProviderPaths[b.provider],e=this.buildOAuthUrl(b.config,b.params,d);if(!d)throw"jToker: providerPath not found for provider: "+b.provider;return this.oAuthDfd=a.Deferred(),this.openAuthWindow(e),this.oAuthDfd.promise()},J.prototype.signOut=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.signOutPath,e=a.Deferred();return a.ajax({url:d,context:this,method:"DELETE",success:function(a){this.resolvePromise(B,e,a)},error:function(a){this.rejectPromise(C,e,a,"Failed to sign out.")},complete:function(){this.invalidateTokens()}}),e.promise()},J.prototype.updateAccount=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.accountUpdatePath,e=a.Deferred();return delete b.config,a.ajax({url:d,context:this,method:"PUT",data:b,success:function(a){var b=c.handleAccountUpdateResponse(a);this.setCurrentUser(b),this.resolvePromise(D,e,a)},error:function(a){this.rejectPromise(E,e,a,"Failed to update user account")}}),e.promise()},J.prototype.destroyAccount=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.accountDeletePath,e=a.Deferred();return a.ajax({url:d,context:this,method:"DELETE",success:function(a){this.invalidateTokens(),this.resolvePromise(F,e,a)},error:function(a){this.rejectPromise(G,e,a,"Failed to destroy user account")}}),e.promise()},J.prototype.requestPasswordReset=function(b){if(b||(b={}),void 0===b.email)throw"jToker: email param undefined for `requestPasswordReset` method.";var c=this.getConfig(b.config),d=this.getApiUrl()+c.passwordResetPath,e=a.Deferred();return b.config_name=b.config,delete b.config,b.redirect_url=c.passwordResetSuccessUrl(),a.ajax({url:d,context:this,method:"POST",data:b,success:function(a){this.resolvePromise(p,e,a)},error:function(a){this.rejectPromise(q,e,a,"Failed to submit email registration.")}}),e.promise()},J.prototype.updatePassword=function(b){b||(b={});var c=this.getConfig(b.config),d=this.getApiUrl()+c.passwordUpdatePath,e=a.Deferred();return delete b.config,a.ajax({url:d,context:this,method:"PUT",data:b,success:function(a){this.resolvePromise(H,e,a)},error:function(a){this.rejectPromise(I,e,a,"Failed to update password.")}}),e.promise()},J.prototype.persistData=function(a,b,c){switch(b=JSON.stringify(b),this.getConfig(c).storage){case"localStorage":e.localStorage.setItem(a,b);break;default:d.set(a,b,{expires:this.getConfig(c).cookieExpiry,path:this.getConfig(c).cookiePath})}},J.prototype.retrieveData=function(b){var c=null;switch(this.getConfig().storage){case"localStorage":c=e.localStorage.getItem(b);break;default:c=d.get(b)}try{return a.parseJSON(c)}catch(a){return L(c)}},J.prototype.getCurrentConfigName=function(){var a=null;return this.getQs().config&&(a=this.getQs().config),d&&!a&&(a=d.get(h)),e.localStorage&&!a&&(a=e.localStorage.getItem(h)),a=a||this.defaultConfigKey||g,L(a)},J.prototype.deleteData=function(a){switch(this.getConfig().storage){case"cookies":d.remove(a,{path:this.getConfig().cookiePath});break;default:e.localStorage.removeItem(a)}},J.prototype.getConfig=function(a){if(!this.configured)throw"jToker: `configure` must be run before using this plugin.";return a=a||this.getCurrentConfigName(),this.configs[a]},J.prototype.appendAuthHeaders=function(a,b){var c=e.auth.retrieveData(i);if(M(b.url)&&c){a.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT");for(var d in e.auth.getConfig().tokenFormat)a.setRequestHeader(d,c[d])}},J.prototype.updateAuthCredentials=function(a,b,c){if(M(c.url)){var d={},f=!0;for(var g in e.auth.getConfig().tokenFormat)d[g]=b.getResponseHeader(g),d[g]&&(f=!1);f||e.auth.persistData(i,d)}},J.prototype.getRawSearch=function(){return e.location.search},J.prototype.getRawAnchor=function(){return e.location.hash},J.prototype.setRawAnchor=function(a){e.location.hash=a},J.prototype.getAnchorSearch=function(){var a=this.getRawAnchor().split("?");return a.length>1?a[1]:null},J.prototype.setRawSearch=function(a){e.location.search=a},J.prototype.setSearchQs=function(b){return this.setRawSearch(a.param(b)),this.getSearchQs()},J.prototype.setAnchorQs=function(b){return this.setAnchorSearch(a.param(b)),this.getAnchorQs()},J.prototype.setLocation=function(a){e.location.replace(a)},J.prototype.createPopup=function(a){return e.open(a)},J.prototype.getSearchQs=function(){var a=this.getRawSearch().replace("?",""),c=a?b(a):{};return c},J.prototype.getAnchorQs=function(){var a=this.getAnchorSearch(),c=a?b(a):{};return c},J.prototype.getQs=function(){return a.extend(this.getSearchQs(),this.getAnchorQs())};var K=function(a){for(var b in a)return b},L=function(a){return a&&a.replace(/("|')/g,"")},M=function(a){return a.match(e.auth.getApiUrl())},N=function(a,b){for(var c=function(a,c){return void 0===b[c]?a:b[c]},d=new RegExp("{{\\s*([a-z0-9-_]+)\\s*}}","ig"),e="";e!==a;a=(e=a).replace(d,c));return a};return e.isOldIE=function(){var a=!1,b=f.userAgent.toLowerCase();if(b&&b.indexOf("msie")!==-1){var c=parseInt(b.split("msie")[1]);c<10&&(a=!0)}return a},e.isIE=function(){var a=e.isOldIE(),b=!!f.userAgent.match(/Trident.*rv\:11\./);return a||b},e.auth=a.auth=new J,e.auth});